var jsPsychHtmlAudioResponse=function(e){"use strict";function t(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}var n={name:"html-audio-response",parameters:{stimulus:{type:e.ParameterType.HTML_STRING,default:void 0},stimulus_duration:{type:e.ParameterType.INT,default:null},recording_duration:{type:e.ParameterType.INT,default:null},show_done_button:{type:e.ParameterType.BOOL,default:!0},done_button_label:{type:e.ParameterType.STRING,default:"Continue"},record_again_button_label:{type:e.ParameterType.STRING,default:"Record again"},accept_button_label:{type:e.ParameterType.STRING,default:"Continue"},allow_playback:{type:e.ParameterType.BOOL,default:!1},save_audio_url:{type:e.ParameterType.BOOL,default:!1},use_voice_key:{type:e.ParameterType.BOOL,default:!0},amplitude_threshold:{type:e.ParameterType.FLOAT,default:.1},timer_duration:{type:e.ParameterType.INT,default:350}}},a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.jsPsych=t,this.rt=null,this.recorded_data_chunks=[],this.meter=null,this.canvasContext=null,this.isLoggingAmplitude=!1,this.amplitudeLoggingTimeoutId=null}var n,a,i;return n=e,(a=[{key:"trial",value:function(e,t){this.jsPsych.pluginAPI.audioContext(),this.recorder=this.jsPsych.pluginAPI.getMicrophoneRecorder(),this.setupRecordingEvents(e,t),this.startRecording(t)}},{key:"showDisplay",value:function(e,t){var n=this;new ResizeObserver((function(t,a){n.stimulus_start_time=performance.now(),a.unobserve(e)})).observe(e),console.log("here0");var a='<div id="jspsych-html-audio-response-stimulus">'.concat(t.stimulus,"</div>")+'<canvas id="meter" width="500" height="50"></canvas>'+'<div id="threshold-display">Threshold: '.concat(t.amplitude_threshold.toFixed(3),"</div>")+'<button id="decrease-threshold" class="jspsych-btn">-</button><button id="increase-threshold" class="jspsych-btn">+</button>';t.show_done_button&&(a+='<p><button class="jspsych-btn" id="finish-trial">'.concat(t.done_button_label,"</button></p>")),e.innerHTML=a,this.startAmplitudeLogging(t),document.getElementById("increase-threshold").addEventListener("click",(function(){n.stopAmplitudeLogging(),t.amplitude_threshold=Math.min(t.amplitude_threshold+.025,1),document.getElementById("threshold-display").textContent="Threshold: ".concat(t.amplitude_threshold.toFixed(3)),n.startAmplitudeLogging(t)})),document.getElementById("decrease-threshold").addEventListener("click",(function(){n.stopAmplitudeLogging(),t.amplitude_threshold=Math.max(t.amplitude_threshold-.025,0),document.getElementById("threshold-display").textContent="Threshold: ".concat(t.amplitude_threshold.toFixed(3)),n.startAmplitudeLogging(t)}))}},{key:"hideStimulus",value:function(e){var t=e.querySelector("#jspsych-html-audio-response-stimulus");t&&(t.style.visibility="hidden");var n=document.getElementById("alert-image");n&&(n.style.opacity="0")}},{key:"addButtonEvent",value:function(e,t){var n=this,a=e.querySelector("#finish-trial");a&&a.addEventListener("click",(function(){var a=performance.now();n.rt=Math.round(a-n.stimulus_start_time),n.stopRecording().then((function(){t.allow_playback?n.showPlaybackControls(e,t):n.endTrial(e,t)}))}))}},{key:"setupRecordingEvents",value:function(e,t){var n=this;this.data_available_handler=function(e){e.data.size>0&&n.recorded_data_chunks.push(e.data)},this.stop_event_handler=function(){var e=new Blob(n.recorded_data_chunks,{type:"audio/webm"}),t=new FileReader;t.addEventListener("load",(function(){var e=t.result.split(",")[1];n.response=e,n.load_resolver()})),t.readAsDataURL(e)},this.start_event_handler=function(a){n.recorded_data_chunks.length=0,n.recorder_start_time=a.timeStamp,n.showDisplay(e,t),n.addButtonEvent(e,t),null!==t.stimulus_duration&&n.jsPsych.pluginAPI.setTimeout((function(){n.hideStimulus(e)}),t.stimulus_duration),null!==t.recording_duration&&n.jsPsych.pluginAPI.setTimeout((function(){"inactive"!==n.recorder.state&&n.stopRecording().then((function(){t.allow_playback?n.showPlaybackControls(e,t):n.endTrial(e,t)}))}),t.recording_duration)},this.recorder.addEventListener("dataavailable",this.data_available_handler),this.recorder.addEventListener("stop",this.stop_event_handler),this.recorder.addEventListener("start",this.start_event_handler)}},{key:"drawVolumeMeter",value:function(e,t){console.log("here4"),this.canvasContext||(this.canvasContext=document.getElementById("meter").getContext("2d"));var n=this.canvasContext.canvas;this.canvasContext.clearRect(0,0,n.width,n.height);var a=e/t,i=Math.min(a,1)*n.width;this.canvasContext.fillStyle=e>t?"red":"green",this.canvasContext.fillRect(0,0,i,n.height)}},{key:"stopAmplitudeLogging",value:function(){this.isLoggingAmplitude=!1,null!==this.amplitudeLoggingTimeoutId&&(this.amplitudeLoggingTimeoutId=null)}},{key:"startAmplitudeLogging",value:function(e){this.stopAmplitudeLogging(),this.logAmplitudeUntilThresholdReached(e,e.amplitude_threshold).then((function(e){console.log(e)})).catch((function(e){console.error(e)}))}},{key:"logAmplitudeUntilThresholdReached",value:function(e,t){var n=this;return new Promise((function(e,a){console.log("here2"),n.isLoggingAmplitude=!0,function i(){if(n.isLoggingAmplitude){n.analyzer.getByteTimeDomainData(n.dataArray);for(var r=0,o=0;o<n.bufferLength;o++){var s=(n.dataArray[o]-128)/128;r+=s*s}var l=Math.sqrt(r/n.bufferLength);if(n.drawVolumeMeter(l,t),l>t){var d=performance.now();console.log("Time from start to amplitude log: ".concat(d-n.startTime," ms"))}Date.now()-n.startTime>n.timeout?a("Timeout reached"):n.isLoggingAmplitude&&(n.amplitudeLoggingTimeoutId=n.jsPsych.pluginAPI.setTimeout(i,16.67))}else e("Amplitude logging stopped")}()}))}},{key:"startRecording",value:function(e){var t=new AudioContext,n=t.createMediaStreamSource(this.recorder.stream);this.analyzer=t.createAnalyser(),n.connect(this.analyzer),this.bufferLength=this.analyzer.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.recorder.start(),this.startTime=performance.now(),console.log("here")}},{key:"stopRecording",value:function(){var e=this;return this.recorder.stop(),new Promise((function(t){e.load_resolver=t}))}},{key:"showPlaybackControls",value:function(e,t){var n=this;e.innerHTML='\n      <button id="record-again" class="jspsych-btn">'.concat(t.record_again_button_label,'</button>\n      <button id="continue" class="jspsych-btn">').concat(t.accept_button_label,"</button>\n    "),e.querySelector("#record-again").addEventListener("click",(function(){n.startRecording(t)})),e.querySelector("#continue").addEventListener("click",(function(){n.endTrial(e,t)}))}},{key:"endTrial",value:function(e,t){this.recorder.removeEventListener("dataavailable",this.data_available_handler),this.recorder.removeEventListener("start",this.start_event_handler),this.recorder.removeEventListener("stop",this.stop_event_handler),this.jsPsych.pluginAPI.clearAllTimeouts();var n={rt:this.rt,stimulus:t.stimulus,response:this.response,estimated_stimulus_onset:Math.round(this.stimulus_start_time-this.recorder_start_time)};e.innerHTML="",this.jsPsych.finishTrial(n)}}])&&t(n.prototype,a),i&&t(n,i),Object.defineProperty(n,"prototype",{writable:!1}),e}();return a.info=n,a}(jsPsychModule);
//# sourceMappingURL=index.browser.min.js.map
