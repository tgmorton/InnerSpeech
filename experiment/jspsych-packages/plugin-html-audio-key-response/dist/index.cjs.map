{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nconst info = <const>{\n  name: \"html-audio-response\",\n  parameters: {\n    /** The HTML string to be displayed */\n    stimulus: {\n      type: ParameterType.HTML_STRING,\n      default: undefined,\n    },\n    /** How long to show the stimulus. */\n    stimulus_duration: {\n      type: ParameterType.INT,\n      default: null,\n    },\n    /** How long to show the trial. */\n    recording_duration: {\n      type: ParameterType.INT,\n      default: 2000,\n    },\n    /** Whether or not to show a button to end the recording. If false, the recording_duration must be set. */\n    show_done_button: {\n      type: ParameterType.BOOL,\n      default: true,\n    },\n    /** Label for the done (stop recording) button. Only used if show_done_button is true. */\n    done_button_label: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n    /** Label for the record again button (only used if allow_playback is true). */\n    record_again_button_label: {\n      type: ParameterType.STRING,\n      default: \"Record again\",\n    },\n    /** Label for the button to accept the audio recording (only used if allow_playback is true). */\n    accept_button_label: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n    /** Whether or not to allow the participant to playback the recording and either accept or re-record. */\n    allow_playback: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n    /** Whether or not to save the video URL to the trial data. */\n    save_audio_url: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n    /** Whether or not to use the voice-key functionality. */\n    use_voice_key: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n    /** The amplitude threshold for the voice-key. */\n    amplitude_threshold: {\n      type: ParameterType.FLOAT,\n      default: 0.1,\n    },\n    /** The duration of the timer that starts when the amplitude threshold is surpassed. */\n    timer_duration: {\n      type: ParameterType.INT,\n      default: 350,\n    },\n    alert_sound: {\n      type: ParameterType.AUDIO,\n      pretty_name: \"alert_sound Sound\",\n      default: undefined,\n    },\n    alert_image: {\n      type: ParameterType.IMAGE,\n      pretty_name: \"Alert Image\",\n      default: undefined,\n    }\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * html-audio-response\n * jsPsych plugin for displaying a stimulus and recording an audio response through a microphone\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/plugins/jspsych-html-audio-response/ html-audio-response plugin documentation on jspsych.org}\n */\nclass HtmlAudioResponsePlugin implements JsPsychPlugin<Info> {\n  static info = info;\n  private stimulus_start_time;\n  private recorder_start_time;\n  private recorder: MediaRecorder;\n  private audio_url;\n  private response;\n  private load_resolver;\n  private rt: number = null;\n  private start_event_handler;\n  private stop_event_handler;\n  private data_available_handler;\n  private recorded_data_chunks = [];\n  private analyzer: any; // Add this property to store the analyzer\n  private dataArray: any; // Add this property to store the data array\n  private bufferLength: any; // Add this property to store the buffer length\n  private amplitudeThreshold: any; // Add this property to store the amplitude threshold\n  private startTime: any; // Add this property to store the start time\n  private timeout: any;\n  private alert_sound;\n  private triggerTime: any;\n  private triggerLatency: any;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    var startTime;\n\n    var context = this.jsPsych.pluginAPI.audioContext();\n\n    // load alert_sound file\n    this.jsPsych.pluginAPI\n      .getAudioBuffer(trial.alert_sound)\n      .then((buffer) => {\n        if (context !== null) {\n          this.alert_sound = context.createBufferSource();\n          this.alert_sound.buffer = buffer;\n          this.alert_sound.connect(context.destination);\n        } else {\n          this.alert_sound = buffer;\n          this.alert_sound.currentTime = 0;\n        }\n      })\n      .catch((err) => {\n        console.error(\n          `Failed to load audio file \"${trial.stimulus}\". Try checking the file path. We recommend using the preload plugin to load audio files.`\n        );\n        console.error(err);\n      });\n    \n    this.recorder = this.jsPsych.pluginAPI.getMicrophoneRecorder();\n\n    this.setupRecordingEvents(display_element, trial);\n\n    this.startRecording(trial);\n  }\n\n  private showDisplay(display_element, trial) {\n    const ro = new ResizeObserver((entries, observer) => {\n      this.stimulus_start_time = performance.now();\n      observer.unobserve(display_element);\n      //observer.disconnect();\n    });\n\n    ro.observe(display_element);\n\n    let html = `<div id=\"jspsych-html-audio-response-stimulus\">${trial.stimulus}</div>`;\n    html += `<div id=\"alert-image\" style=\"position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; \">\n                <img src=\"${trial.alert_image}\" style=\"width: 250px;\">\n             </div>`;\n    \n    if (trial.show_done_button) {\n      html += `<p><button class=\"jspsych-btn\" id=\"finish-trial\">${trial.done_button_label}</button></p>`;\n    }\n\n    display_element.innerHTML = html;\n  }\n\n  private hideStimulus(display_element: HTMLElement) {\n    const el: HTMLElement = display_element.querySelector(\"#jspsych-html-audio-response-stimulus\");\n    if (el) {\n      el.style.visibility = \"hidden\";\n    }\n    const alertImage: HTMLElement = document.getElementById(\"alert-image\");\n    if (alertImage) {\n      alertImage.style.opacity = \"0\";\n    }\n  }\n\n  private showAlertImage() {\n    const alertImage: HTMLElement = document.getElementById(\"alert-image\");\n    if (alertImage) {\n      alertImage.style.opacity = \"1\";\n    }\n  }\n\n  private changeDisplay(display_element: HTMLElement, newContent: string) {\n    display_element.innerHTML = newContent;\n  }\n\n  private addButtonEvent(display_element, trial) {\n    const btn = display_element.querySelector(\"#finish-trial\");\n    if (btn) {\n      btn.addEventListener(\"click\", () => {\n        const end_time = performance.now();\n        this.rt = Math.round(end_time - this.stimulus_start_time);\n        this.stopRecording().then(() => {\n          if (trial.allow_playback) {\n            this.showPlaybackControls(display_element, trial);\n          } else {\n            this.endTrial(display_element, trial);\n          }\n        });\n      });\n    }\n  }\n\n  private setupRecordingEvents(display_element, trial) {\n    this.data_available_handler = (e) => {\n      if (e.data.size > 0) {\n        this.recorded_data_chunks.push(e.data);\n      }\n    };\n\n    this.stop_event_handler = () => {\n      const data = new Blob(this.recorded_data_chunks, { type: \"audio/webm\" });\n      this.audio_url = URL.createObjectURL(data);\n      const reader = new FileReader();\n      reader.addEventListener(\"load\", () => {\n        const base64 = (reader.result as string).split(\",\")[1];\n        this.response = base64;\n        this.load_resolver();\n      });\n      reader.readAsDataURL(data);\n    };\n\n    this.start_event_handler = (e) => {\n      // resets the recorded data\n      this.recorded_data_chunks.length = 0;\n\n      this.recorder_start_time = e.timeStamp;\n      this.showDisplay(display_element, trial);\n      this.addButtonEvent(display_element, trial);\n\n      // setup timer for hiding the stimulus\n      if (trial.stimulus_duration !== null) {\n        this.jsPsych.pluginAPI.setTimeout(() => {\n          this.hideStimulus(display_element);\n        }, trial.stimulus_duration);\n      }\n\n      // setup timer for ending the trial\n      if (trial.recording_duration !== null) {\n        this.jsPsych.pluginAPI.setTimeout(() => {\n          // this check is necessary for cases where the\n          // done_button is clicked before the timer expires\n          if (this.recorder.state !== \"inactive\") {\n            this.stopRecording().then(() => {\n              if (trial.allow_playback) {\n                this.showPlaybackControls(display_element, trial);\n              } else {\n                this.endTrial(display_element, trial);\n              }\n            });\n          }\n        }, trial.recording_duration);\n      }\n    };\n\n    this.recorder.addEventListener(\"dataavailable\", this.data_available_handler);\n\n    this.recorder.addEventListener(\"stop\", this.stop_event_handler);\n\n    this.recorder.addEventListener(\"start\", this.start_event_handler);\n  }\n\n  private injectInvertColorsCSS() {\n    const style = document.createElement('style');\n    style.textContent = `\n      body {\n        filter: invert(1);\n      }\n    `;\n    document.head.append(style);\n  }\n\n  private logAmplitudeUntilThresholdReached(trial) {\n    return new Promise((resolve, reject) => {\n      const logAmplitude = () => {\n        // Get the audio data from the analyzer\n        this.analyzer.getByteTimeDomainData(this.dataArray);\n  \n        // Calculate the amplitude\n        let sum = 0;\n        for (let i = 0; i < this.bufferLength; i++) {\n          const value = (this.dataArray[i] - 128) / 128;\n          sum += value * value;\n        }\n        const amplitude = Math.sqrt(sum / this.bufferLength);\n        //console.log(trial.amplitude_threshold);\n  \n        // If the amplitude exceeds the threshold, resolve the promise\n        if (amplitude > trial.amplitude_threshold) {\n          const endTime = performance.now(); // Store the end time\n          console.log(`Time from start to amplitude log: ${endTime - this.startTime} ms`);\n          resolve('Amplitude threshold reached');\n          return;\n        }\n  \n        // If the timeout has been reached, reject the promise\n        if (Date.now() - this.startTime > this.timeout) {\n          reject('Timeout reached');\n          return;\n        }\n  \n        // Schedule the next log\n        this.jsPsych.pluginAPI.setTimeout(logAmplitude, 5); // Adjust the time interval as needed (in milliseconds)\n      };\n  \n      logAmplitude();\n    });\n  }\n\n  private playAlertSound() {\n    if (this.alert_sound) {\n      if (this.alert_sound instanceof AudioBufferSourceNode) {\n        this.alert_sound.start();\n      } else {\n        this.alert_sound.play();\n      }\n    }\n  }\n\n  private startRecording(trial) {\n    // Initialize the analyzer\n    const audioContext = new AudioContext();\n    const source = audioContext.createMediaStreamSource(this.recorder.stream);\n    this.analyzer = audioContext.createAnalyser();\n    source.connect(this.analyzer);\n    this.bufferLength = this.analyzer.frequencyBinCount\n    this.dataArray = new Uint8Array(this.bufferLength);\n    \n    this.recorder.start();\n    this.startTime = performance.now(); // Store the start time\n    this.jsPsych.pluginAPI.setTimeout(() => {\n      this.logAmplitudeUntilThresholdReached(trial)\n      .then(\n        message => {\n          console.log(message);\n          var triggerTimeRaw = performance.now()\n          this.triggerTime = triggerTimeRaw - this.startTime\n          console.log(this.triggerTime)\n          this.jsPsych.pluginAPI.setTimeout(() => {\n            if (trial.use_voice_key) {\n              this.showAlertImage();\n              this.playAlertSound();\n            }\n            this.triggerLatency = performance.now() - triggerTimeRaw\n            console.log(this.triggerLatency)\n          }, trial.timer_duration);\n        }\n        )\n      .catch(error => console.error(error));\n      }, 100);\n  }\n\n  private stopRecording() {\n    this.recorder.stop();\n    return new Promise((resolve) => {\n      this.load_resolver = resolve;\n    });\n  }\n\n  private showPlaybackControls(display_element, trial) {\n    display_element.innerHTML = `\n      <p><audio id=\"playback\" src=\"${this.audio_url}\" controls></audio></p>\n      <button id=\"record-again\" class=\"jspsych-btn\">${trial.record_again_button_label}</button>\n      <button id=\"continue\" class=\"jspsych-btn\">${trial.accept_button_label}</button>\n    `;\n\n    display_element.querySelector(\"#record-again\").addEventListener(\"click\", () => {\n      // release object url to save memory\n      URL.revokeObjectURL(this.audio_url);\n      this.startRecording(trial);\n    });\n    display_element.querySelector(\"#continue\").addEventListener(\"click\", () => {\n      this.endTrial(display_element, trial);\n    });\n\n    // const audio = display_element.querySelector('#playback');\n    // audio.src =\n  }\n\n  private endTrial(display_element, trial) {\n    // clear recordering event handler\n\n    this.recorder.removeEventListener(\"dataavailable\", this.data_available_handler);\n    this.recorder.removeEventListener(\"start\", this.start_event_handler);\n    this.recorder.removeEventListener(\"stop\", this.stop_event_handler);\n\n    // kill any remaining setTimeout handlers\n    this.jsPsych.pluginAPI.clearAllTimeouts();\n\n    // gather the data to store for the trial\n    var trial_data: any = {\n      rt: this.rt,\n      stimulus: trial.stimulus,\n      response: this.response,\n      estimated_stimulus_onset: Math.round(this.stimulus_start_time - this.recorder_start_time),\n      trigger_time: this.triggerTime,\n      trigger_latency: this.triggerLatency\n    };\n\n    if (trial.save_audio_url) {\n      trial_data.audio_url = this.audio_url;\n    } else {\n      URL.revokeObjectURL(this.audio_url);\n    }\n\n    // clear the display\n    display_element.innerHTML = \"\";\n\n    // move on to the next trial\n    this.jsPsych.finishTrial(trial_data);\n  }\n}\n\nexport default HtmlAudioResponsePlugin;\n"],"names":["ParameterType"],"mappings":"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"}