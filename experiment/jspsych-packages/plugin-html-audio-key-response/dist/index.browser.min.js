var jsPsychHtmlAudioResponse=function(e){"use strict";function t(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}var r={name:"html-audio-response",parameters:{stimulus:{type:e.ParameterType.HTML_STRING,default:void 0},stimulus_duration:{type:e.ParameterType.INT,default:null},recording_duration:{type:e.ParameterType.INT,default:2e3},show_done_button:{type:e.ParameterType.BOOL,default:!0},done_button_label:{type:e.ParameterType.STRING,default:"Continue"},record_again_button_label:{type:e.ParameterType.STRING,default:"Record again"},accept_button_label:{type:e.ParameterType.STRING,default:"Continue"},allow_playback:{type:e.ParameterType.BOOL,default:!1},save_audio_url:{type:e.ParameterType.BOOL,default:!1},use_voice_key:{type:e.ParameterType.BOOL,default:!1},amplitude_threshold:{type:e.ParameterType.FLOAT,default:.1},timer_duration:{type:e.ParameterType.INT,default:350},alert_sound:{type:e.ParameterType.AUDIO,pretty_name:"alert_sound Sound",default:void 0},alert_image:{type:e.ParameterType.IMAGE,pretty_name:"Alert Image",default:void 0}}},a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.jsPsych=t,this.rt=null,this.recorded_data_chunks=[]}var r,a,n;return r=e,(a=[{key:"trial",value:function(e,t){var r=this,a=this.jsPsych.pluginAPI.audioContext();this.jsPsych.pluginAPI.getAudioBuffer(t.alert_sound).then((function(e){null!==a?(r.alert_sound=a.createBufferSource(),r.alert_sound.buffer=e,r.alert_sound.connect(a.destination)):(r.alert_sound=e,r.alert_sound.currentTime=0)})).catch((function(e){console.error('Failed to load audio file "'.concat(t.stimulus,'". Try checking the file path. We recommend using the preload plugin to load audio files.')),console.error(e)})),this.recorder=this.jsPsych.pluginAPI.getMicrophoneRecorder(),this.setupRecordingEvents(e,t),this.startRecording(t)}},{key:"showDisplay",value:function(e,t){var r=this;new ResizeObserver((function(t,a){r.stimulus_start_time=performance.now(),a.unobserve(e)})).observe(e);var a='<div id="jspsych-html-audio-response-stimulus">'.concat(t.stimulus,"</div>");a+='<div id="alert-image" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; ">\n                <img src="'.concat(t.alert_image,'" style="width: 250px;">\n             </div>'),t.show_done_button&&(a+='<p><button class="jspsych-btn" id="finish-trial">'.concat(t.done_button_label,"</button></p>")),e.innerHTML=a}},{key:"hideStimulus",value:function(e){var t=e.querySelector("#jspsych-html-audio-response-stimulus");t&&(t.style.visibility="hidden");var r=document.getElementById("alert-image");r&&(r.style.opacity="0")}},{key:"showAlertImage",value:function(){var e=document.getElementById("alert-image");e&&(e.style.opacity="1")}},{key:"changeDisplay",value:function(e,t){e.innerHTML=t}},{key:"addButtonEvent",value:function(e,t){var r=this,a=e.querySelector("#finish-trial");a&&a.addEventListener("click",(function(){var a=performance.now();r.rt=Math.round(a-r.stimulus_start_time),r.stopRecording().then((function(){t.allow_playback?r.showPlaybackControls(e,t):r.endTrial(e,t)}))}))}},{key:"setupRecordingEvents",value:function(e,t){var r=this;this.data_available_handler=function(e){e.data.size>0&&r.recorded_data_chunks.push(e.data)},this.stop_event_handler=function(){var e=new Blob(r.recorded_data_chunks,{type:"audio/webm"});r.audio_url=URL.createObjectURL(e);var t=new FileReader;t.addEventListener("load",(function(){var e=t.result.split(",")[1];r.response=e,r.load_resolver()})),t.readAsDataURL(e)},this.start_event_handler=function(a){r.recorded_data_chunks.length=0,r.recorder_start_time=a.timeStamp,r.showDisplay(e,t),r.addButtonEvent(e,t),null!==t.stimulus_duration&&r.jsPsych.pluginAPI.setTimeout((function(){r.hideStimulus(e)}),t.stimulus_duration),null!==t.recording_duration&&r.jsPsych.pluginAPI.setTimeout((function(){"inactive"!==r.recorder.state&&r.stopRecording().then((function(){t.allow_playback?r.showPlaybackControls(e,t):r.endTrial(e,t)}))}),t.recording_duration)},this.recorder.addEventListener("dataavailable",this.data_available_handler),this.recorder.addEventListener("stop",this.stop_event_handler),this.recorder.addEventListener("start",this.start_event_handler)}},{key:"injectInvertColorsCSS",value:function(){var e=document.createElement("style");e.textContent="\n      body {\n        filter: invert(1);\n      }\n    ",document.head.append(e)}},{key:"logAmplitudeUntilThresholdReached",value:function(e){var t=this;return new Promise((function(r,a){!function n(){t.analyzer.getByteTimeDomainData(t.dataArray);for(var i=0,o=0;o<t.bufferLength;o++){var s=(t.dataArray[o]-128)/128;i+=s*s}if(Math.sqrt(i/t.bufferLength)>e.amplitude_threshold){var u=performance.now();return console.log("Time from start to amplitude log: ".concat(u-t.startTime," ms")),void r("Amplitude threshold reached")}Date.now()-t.startTime>t.timeout?a("Timeout reached"):t.jsPsych.pluginAPI.setTimeout(n,5)}()}))}},{key:"playAlertSound",value:function(){this.alert_sound&&(this.alert_sound instanceof AudioBufferSourceNode?this.alert_sound.start():this.alert_sound.play())}},{key:"startRecording",value:function(e){var t=this,r=new AudioContext,a=r.createMediaStreamSource(this.recorder.stream);this.analyzer=r.createAnalyser(),a.connect(this.analyzer),this.bufferLength=this.analyzer.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.recorder.start(),this.startTime=performance.now(),this.jsPsych.pluginAPI.setTimeout((function(){t.logAmplitudeUntilThresholdReached(e).then((function(r){console.log(r);var a=performance.now();t.triggerTime=a-t.startTime,console.log(t.triggerTime),t.jsPsych.pluginAPI.setTimeout((function(){e.use_voice_key&&(t.showAlertImage(),t.playAlertSound()),t.triggerLatency=performance.now()-a,console.log(t.triggerLatency)}),e.timer_duration)})).catch((function(e){return console.error(e)}))}),100)}},{key:"stopRecording",value:function(){var e=this;return this.recorder.stop(),new Promise((function(t){e.load_resolver=t}))}},{key:"showPlaybackControls",value:function(e,t){var r=this;e.innerHTML='\n      <p><audio id="playback" src="'.concat(this.audio_url,'" controls></audio></p>\n      <button id="record-again" class="jspsych-btn">').concat(t.record_again_button_label,'</button>\n      <button id="continue" class="jspsych-btn">').concat(t.accept_button_label,"</button>\n    "),e.querySelector("#record-again").addEventListener("click",(function(){URL.revokeObjectURL(r.audio_url),r.startRecording(t)})),e.querySelector("#continue").addEventListener("click",(function(){r.endTrial(e,t)}))}},{key:"endTrial",value:function(e,t){this.recorder.removeEventListener("dataavailable",this.data_available_handler),this.recorder.removeEventListener("start",this.start_event_handler),this.recorder.removeEventListener("stop",this.stop_event_handler),this.jsPsych.pluginAPI.clearAllTimeouts();var r={rt:this.rt,stimulus:t.stimulus,response:this.response,estimated_stimulus_onset:Math.round(this.stimulus_start_time-this.recorder_start_time),trigger_time:this.triggerTime,trigger_latency:this.triggerLatency};t.save_audio_url?r.audio_url=this.audio_url:URL.revokeObjectURL(this.audio_url),e.innerHTML="",this.jsPsych.finishTrial(r)}}])&&t(r.prototype,a),n&&t(r,n),Object.defineProperty(r,"prototype",{writable:!1}),e}();return a.info=r,a}(jsPsychModule);
//# sourceMappingURL=index.browser.min.js.map
